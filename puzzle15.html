<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="">
  <meta name="keywords" content="Puzzle 15">
  <title>Puzzle 15</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="tufte.css">
  <link rel="stylesheet" href="pandoc.css">
  <link rel="stylesheet" href="pandoc-solarized-dark.css">
  <link rel="stylesheet" href="tufte-extra.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article>
<header>
<h1 class="title">Puzzle 15</h1>
</header>
<nav id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#forth">Forth</a></li>
<li><a href="#d">D</a></li>
<li><a href="#appendix-forth">Appendix Forth</a></li>
<li><a href="#appendix-d">Appendix D</a></li>
<li><a href="#appendix-d-oop">Appendix D OOP</a></li>
</ul>
</nav>
<p>Date: 2020-09-16</p>
<p>Keywords: <a href="https://en.wikipedia.org/wiki/15_puzzle">puzzle 15</a>, <a href="http://webassembly.arsdnet.net/number">ADR’s numbers game</a></p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I was inspired by <a href="http://webassembly.arsdnet.net/number">ADR’s numbers game</a><span><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="sidenote">Adam’s blog and code is way cooler than this, so your time would be better spent reading those articles than mine for right now.<br />
<br />
</span></span> and thought to try to code it myself. I wrote a version in <a href="#forth">Forth</a> first, then a version that is more how I write D (but ported from the Forth version), and a version that is a little more OOP leaning in D. I should have taken more notes while I was doing this exercise, but I didn’t.<span><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle"/><span class="sidenote">There really isn’t much point to this article other than to have some content to test out the <a href="https://github.com/">Github</a> user page stuff and <a href="https://pandoc.org/">Pandoc</a>.<br />
<br />
</span></span></p>
<p><em>Puzzle 15</em> is a game on a 4 x 4 grid with 15 tiles and space. The object is to line the tiles up in order. I thought it would be a nice programming exercise to play with Forth, which I have not done for a very long time.</p>
<p>The approach in this code differs from <a href="http://webassembly.arsdnet.net/number">ADR’s numbers game</a> in a couple of ways. First, there is no selection tile so the user can only move 1 tile at time. Movement keys are mapped to <code>Vi</code> or arrow keys. Second, the board starts in an initialized state of a final solution and then randomly makes moves. This ensures the board stays in a solvable state. There is some math voodoo that can be done to ensure this, but I thought this was easier.</p>
</section>
<section id="forth" class="level1">
<h1>Forth</h1>
<p>The great thing about Forth is the REPL and how functions compose. There are a number of things that are less great, but for this kind of problem, Forth is a perfectly suited language for it.</p>
<p>The source lines of code for this version are right around 110 lines. About 10 of those lines come from including a pseudo random number generator.<span><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle"/><span class="sidenote">I was thinking that this was a good candidate for another project I dabble with, so wanted to reduce dependencies. I ended up with utime for the seed, so still ended up with a dependency.<br />
<br />
</span></span></p>
<p>This implementation works with <a href="https://www.gnu.org/software/gforth/">GForth</a>.</p>
<p>A few observations while I was writing the Forth version.</p>
<ol type="1">
<li><p>It is fun and relatively painless to refactor.</p>
<p>This is likely due to a number of reasons. One is that Forth words are basically a High level Intermediate language. These definitions can be thought of as a tree. Therefore, common refactoring things are <em>extracting sequence into a new word</em>, <em>moving sequence up or down the tree</em>, or <em>expanding a word in place</em>, possibly in preparation for another refactoring.<span><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle"/><span class="sidenote">I need to record myself writing this program to really capture the ease and flow of writing the code. I don’t know how to explain it.<br />
<br />
</span></span></p>
<p>Variables and constants are global. Don’t have to worry about arguments or scopes causing friction in refactoring. It’s all lexical and logical organization.<span><label for="sn-5" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-5" class="margin-toggle"/><span class="sidenote">This is obviously one of the downsides of long term maintenance an<br />
<br />
</span></span></p>
<p>Expressions are postfix and pass parameters on the stack. This becomes quite natural really quickly.<span><label for="sn-6" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-6" class="margin-toggle"/><span class="sidenote">There are some “code smells” specific to Forth. For example, excessive <code>swap</code>s or <code>rotate</code>s. As long as these aren’t in the word definitions, refactoring seems pretty seamless.<br />
<br />
</span></span></p></li>
</ol>
<ol start="3" type="1">
<li><p>The code is “dense” in that it implements the Puzzle-15 game in about 100 lines of code. The D versions are close to 2x this amount and I’m not sure why (yet).</p></li>
<li><p>I noticed that I wrote 3 styles of code for this program. There is the most common <em>one liner</em> style the typifies Forth definitions. There is a <em>vertical block</em> style that seems natural for <code>CASE</code> statements and matching patterns. There is sort of a <em>free form</em> style that doesn’t match either of the other two. This could be a code smell. I haven’t written enough Forth code to know.</p></li>
<li><p>The Forth runtime was nice. No worrying about ncurses or anything, the terminal worked as expected with <code>."</code> and <code>key</code>.</p></li>
<li><p>There is no need for string interpolation <code>." There are " noApples @ . ."  apples"</code> just switches between string and expression contexts very naturally.</p></li>
<li><p>While <code>@</code> and <code>!</code> are natural for fetching and storing values to variables, they are not nearly as nice as an array syntax.</p></li>
<li><p>I like strong types and missed them in this exercise.</p></li>
<li><p>It is very nice to <em>name</em> expressions. For example <code>0 moves !</code> vs <code>resetMoves</code> both seem very similar but sort of different in <code>init shuffleBoard resetMoves gameLoop</code>. I note that in this context, <code>resetMoves</code> might be better named something else, maybe <code>prepareMoves</code>.</p></li>
</ol>
</section>
<section id="d" class="level1">
<h1>D</h1>
<p>D and C++ are the main languages I’m coding in right now. As a comparison, I copied the Forth code and then did as simple of a direct translation as I could. Thus the D code looks very Forth-like in this implementation, though a lot of my code looks Forth-like because I like refactoring<span><label for="sn-7" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-7" class="margin-toggle"/><span class="sidenote">My rule of thumb is to only have 1 control structure per function, which I find to be a great place to aim for.<br />
<br />
</span></span> functions until they do one thing.</p>
<p>A few observations while I was writing the D version.</p>
<ol type="1">
<li>I really like nested functions for limiting the scope and putting the function declarations next to where they are used. There are some things that are different from functions outside. I’m not sure it is the way that I use them or what, but it seems to be:
<ol type="1">
<li>For example, they get a frame pointer to their parent which is cool and there is <code>static</code> if it only uses the function arguments.<br />
</li>
<li>UFCS doesn’t seem to work with nested functions. I’m not sure if it supposed to or not.</li>
<li>Functions have to be declared before they are used.</li>
</ol></li>
<li><p>The direction translation in my style was about 250 lines long. This includes 50 lines of opening <code>{</code> since I prefer them on a new line rather than trailing on the far right. Still this is surprising that the code is 2x the size. I didn’t even expand all functions into multiple lines, i.e. the <em>one-liners</em> still stayed one line.</p></li>
<li><p>I’m not sure how to return a single character from keyboard, because <code>stdin</code> seems to be line buffered, so I looped in <code>ncurses</code>. Completely overkill for this exercise, but probably desirable in a real program that was going to be used in a serious manner.<span><label for="sn-8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-8" class="margin-toggle"/><span class="sidenote">Pressing <code>ENTER</code> after every key immediately makes the game unplayable. It kind of surprises me that such a thing can make such a difference in experience, but I’ve seen this over and over in UIs. An extra click, excessive pop-up. They just disrupt or add to cognitive load enough to make the experience not enjoyable. Similarly, adding in <code>Vi</code> movement keys felt very natural and increased the experience, though I’m sure it would not have the same effect for users of other IDEs.<br />
<br />
</span></span></p></li>
<li><p>I didn’t know how to effect state outside a loop, without using a global variable in Forth version, so I did that with the <code>?win</code> variable and functions. The D version can just put the <code>isWinner</code> condition check in the <code>if</code> condition, which was simpler.</p></li>
<li><p>I’m much more comfortable programming in D or C++ than I am in Forth.</p></li>
<li>The 250 lines of D expanded to 35,000 lines of assembly language!<span><label for="sn-9" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-9" class="margin-toggle"/><span class="sidenote">I used ldc -O3 –output-ll and –output-s for looking at assembly output.<br />
<br />
</span></span> It looked like there were a lot of lines related to exceptions, bounds checking, and thread local storage. In the first version, a fixed sized array and a few variables were used, so there wasn’t any direct user code allocation. I think many of the things were due to the <em>write</em> family of functions.</li>
<li><p>This program on an x86_64 is about 60k bytes of a 1.4M bytes stripped executable. 60k still seems pretty excessive to me for this simple program.<span><label for="sn-10" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-10" class="margin-toggle"/><span class="sidenote">Note that a hello world stripped executable is also 1.4M bytes. So that is all the runtime and startup<br />
<br />
</span></span></p></li>
</ol>
</section>
<section id="appendix-forth" class="level1">
<h1>Appendix Forth</h1>
<p><em>Note:</em> Apparently Pandoc doesn’t support Forth for syntax highlighting.</p>
<p><em>Note:</em> I’m not sure all of the stack effect comments are correct.</p>
<pre class="forth"><code>\ A board is an array of 16 cells to make a 4 x 4 layout
\ The Tiles have the values 0 - 16 where 16 is the &#39;Space&#39;
\ Thus, if the index is the same as the value for all 16 places
\    the board is in a winning configuration.
\ 
\ Use vi keys to shift one tile to the left, right, up, down
\ Use x to leave the game

4   CONSTANT SIZE           \ an n x n board
100 CONSTANT RANDOMLEVEL    \ Bigger is harder (more shuffling)

SIZE dup *   CONSTANT BOARDSIZE
BOARDSIZE 1- CONSTANT BLANKHOME

VARIABLE board BOARDSIZE CELLS allot
VARIABLE blankPos BOARDSIZE             \ The index/position of the &#39;space&#39; tile
VARIABLE ?gameOver                      \ Games end because user e&#39;x&#39;its or wins
( -- ) :  gameOver 1 ?gameOver ! ;
( -- ) : -gameOver 0 ?gameOver ! ;

( -- ) : initBoard BOARDSIZE 0 DO i board i CELLS + ! LOOP ;
( -- ) : initBlankPos BLANKHOME blankPos ! ;

VARIABLE ?win               \ Variable if the board state is a winner
( -- ) :  winner 1 ?win ! ;
( -- ) : -winner 0 ?win ! ;
( -- ) : updateWinner winner BOARDSIZE 0 DO i board i CELLS + @ &lt;&gt; IF -winner THEN LOOP ;

( idx -- ) : ?newLine SIZE MOD 0= IF cr THEN ;
( tile -- ) : showTile dup BLANKHOME = IF space space space ELSE dup 10 &lt; IF space . ELSE . THEN THEN ;
( -- ) : showBoard BOARDSIZE 0 DO i ?newLine board i CELLS + @ showTile LOOP ;

( -- key ) : askForMove .&quot; hjklxq?&gt; &quot; key cr ;

( -- row ) : blankRow blankPos @ SIZE / ;
( -- col ) : blankCol blankPos @ SIZE MOD ;

\ These use board indexes
( idx -- )       : tile@ cells board + @ ;
( tile idx -- )  : tile! cells board + ! ;
( idx1 idx2 -- ) : swapTiles dup tile@ &gt;r over tile@ swap tile! r&gt; swap tile!  ;

\ These are the valid move checks
( -- b ) : ?right blankCol ; \ 0 is invalid, 1 2 3 are all true
( -- b ) : ?left  blankCol SIZE 1- &lt;&gt; ;
( -- b ) : ?up    blankRow SIZE 1- &lt;&gt; ;
( -- b ) : ?down  blankRow ;

VARIABLE moves
( -- ) : moves+1 moves @ 1+ moves ! ;
( -- ) : resetMoves 0 moves ! ;
( n -- ) : moveTile  blankPos @ + dup blankPos @  swapTiles blankPos ! moves+1 ;
( -- ) : left  1 moveTile ;
( -- ) : down  SIZE negate moveTile ;
( -- ) : up    SIZE moveTile ;
( -- ) : right 1 negate moveTile ;

( -- ) : doLeft  ?left  IF left  THEN ;
( -- ) : doDown  ?down  IF down  THEN ;
( -- ) : doUp    ?up    IF up    THEN ;
( -- ) : doRight ?right IF right THEN ;
( -- ) : leaveGame .&quot; Leaving game.  Thank you for playing.&quot; cr gameOver ;
( -- ) : doHelp cr
    .&quot;   h or left  arrow moves tile left  into blank space.&quot; cr
    .&quot;   l or right arrow moves tile right into blank space.&quot; cr
    .&quot;   j or down  arrow moves tile down  into blank space.&quot; cr
    .&quot;   k or up    arrow moves tile up    into blank space.&quot; cr
    .&quot;   x,q Abandons current game.&quot; cr
    .&quot;   ? This help screen.&quot; cr ;

( key -- ) : handleKey CASE 
    113 OF leaveGame ENDOF \ &#39;q&#39;
    120 OF leaveGame ENDOF \ &#39;x&#39;
    104 OF doLeft  ENDOF   \ &#39;l&#39;
    106 OF doDown  ENDOF   \ &#39;j&#39;
    107 OF doUp    ENDOF   \ &#39;k&#39;
    108 OF doRight ENDOF   \ &#39;l&#39;
     68 OF doLeft  ENDOF   \ arrows
     66 OF doDown  ENDOF
     65 OF doUp    ENDOF
     67 OF doRight ENDOF
     63 OF doHelp  ENDOF
    .&quot; You pressed &quot; . cr
    ENDCASE ;


     16807 CONSTANT a
2147483647 CONSTANT m

VARIABLE MYSEED
( -- ) : checkSeed MYSEED @ 0= IF utime drop MYSEED ! recurse THEN ;
( -- ) : seed checkSeed a MYSEED @ * m mod MYSEED ! ;
( m -- ) : random seed MYSEED @ swap mod ;

VARIABLE lastShuffleMove
( n -- b ) : ?avoidUndoMove lastShuffleMove @ &lt;&gt; ;
( -- ) : shuffleOneMove 4 random CASE
    0 OF .&quot; L&quot; 3 ?avoidUndoMove IF doLeft  0 lastShuffleMove ! THEN ENDOF
    1 OF .&quot; D&quot; 2 ?avoidUndoMove IF doDown  1 lastShuffleMove ! THEN ENDOF
    2 OF .&quot; U&quot; 1 ?avoidUndoMove IF doUp    2 lastShuffleMove ! THEN ENDOF
    3 OF .&quot; R&quot; 0 ?avoidUndoMove IF doRight 3 lastShuffleMove ! THEN ENDOF
    ENDCASE
    ;


( -- ) : shuffleBoard resetMoves BEGIN shuffleOneMove moves @ RANDOMLEVEL = UNTIL ;
( -- ) : init initBoard initBlankPos -gameOver ;
( -- ) : movesMessage .&quot; It took &quot; moves @ . .&quot; moves to complete.&quot; cr ;
( -- ) : congratulate cr .&quot; !!! Congratulations on winning the game !!!&quot; cr movesMessage ;
( -- ) : turn showBoard cr askForMove handleKey ;
( -- ) : gameBody turn updateWinner ?win @ IF showBoard congratulate gameOver THEN ;
( -- ) : gameLoop BEGIN gameBody ?gameOver @ UNTIL ;
( -- ) : game init shuffleBoard resetMoves gameLoop ;
( -- ) : anotherGame BEGIN game cr .&quot; Would you like to play again, y/n?&quot; key 121 &lt;&gt; UNTIL ;
anotherGame
cr bye</code></pre>
</section>
<section id="appendix-d" class="level1">
<h1>Appendix D</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode d"><code class="sourceCode d"><a class="sourceLine" id="cb2-1" title="1"><span class="co">/+</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">A board is an array of 16 cells to make a 4 x 4 layout</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co">The Tiles have the values 0 - 16 where 16 is the &#39;Space&#39;</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">Thus, if the index is the same as the value for all 16 places</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co">   the board is in a winning configuration.</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">Use vi keys to shift one tile to the left, right, up, down</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">Use x to leave the game</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co">+/</span></a>
<a class="sourceLine" id="cb2-10" title="10"></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="kw">import</span> std.algorithm.mutation : swap;</a>
<a class="sourceLine" id="cb2-12" title="12"><span class="kw">import</span> std.range : iota;</a>
<a class="sourceLine" id="cb2-13" title="13"><span class="kw">import</span> std.stdio : write, writef, writefln, writeln, stdout;</a>
<a class="sourceLine" id="cb2-14" title="14"><span class="kw">import</span> std.array : array;</a>
<a class="sourceLine" id="cb2-15" title="15"><span class="kw">import</span> std.random : choice;</a>
<a class="sourceLine" id="cb2-16" title="16"></a>
<a class="sourceLine" id="cb2-17" title="17"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb2-18" title="18">@safe:</a>
<a class="sourceLine" id="cb2-19" title="19"></a>
<a class="sourceLine" id="cb2-20" title="20"><span class="kw">extern</span>(C) <span class="dt">int</span> getch();</a>
<a class="sourceLine" id="cb2-21" title="21"></a>
<a class="sourceLine" id="cb2-22" title="22"><span class="kw">const</span> SIZE = <span class="dv">4</span>;           <span class="co">// an n x n board</span></a>
<a class="sourceLine" id="cb2-23" title="23"><span class="kw">const</span> RANDOMLEVEL = <span class="dv">600</span>;  <span class="co">// Bigger is harder (more shuffling)</span></a>
<a class="sourceLine" id="cb2-24" title="24"></a>
<a class="sourceLine" id="cb2-25" title="25"><span class="kw">const</span> BOARDSIZE = SIZE * SIZE;</a>
<a class="sourceLine" id="cb2-26" title="26"><span class="kw">const</span> BLANKHOME = BOARDSIZE - <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb2-27" title="27"></a>
<a class="sourceLine" id="cb2-28" title="28"><span class="kw">const</span> <span class="kw">auto</span> boardInit = iota(<span class="dv">0</span>,BOARDSIZE).array;</a>
<a class="sourceLine" id="cb2-29" title="29"><span class="dt">int</span>[BOARDSIZE] board;</a>
<a class="sourceLine" id="cb2-30" title="30"><span class="dt">long</span> blankPos = BOARDSIZE;</a>
<a class="sourceLine" id="cb2-31" title="31"><span class="kw">auto</span> blankRow() { <span class="kw">return</span> blankPos / SIZE; }</a>
<a class="sourceLine" id="cb2-32" title="32"><span class="kw">auto</span> blankCol() { <span class="kw">return</span> blankPos % SIZE; }</a>
<a class="sourceLine" id="cb2-33" title="33"></a>
<a class="sourceLine" id="cb2-34" title="34"><span class="dt">bool</span> qGameOver;</a>
<a class="sourceLine" id="cb2-35" title="35"><span class="dt">void</span>   setGameOver() { qGameOver = <span class="kw">true</span>; }</a>
<a class="sourceLine" id="cb2-36" title="36"><span class="dt">void</span> resetGameOver() { qGameOver = <span class="kw">false</span>; }</a>
<a class="sourceLine" id="cb2-37" title="37"></a>
<a class="sourceLine" id="cb2-38" title="38"><span class="dt">long</span> moves;</a>
<a class="sourceLine" id="cb2-39" title="39"></a>
<a class="sourceLine" id="cb2-40" title="40">@trusted</a>
<a class="sourceLine" id="cb2-41" title="41"><span class="dt">void</span> anotherGame() {</a>
<a class="sourceLine" id="cb2-42" title="42">    <span class="kw">static</span> <span class="dt">void</span> playGame() {</a>
<a class="sourceLine" id="cb2-43" title="43">        <span class="kw">static</span> <span class="dt">void</span> initGame() {</a>
<a class="sourceLine" id="cb2-44" title="44">            board[]  = boardInit;</a>
<a class="sourceLine" id="cb2-45" title="45">            blankPos = BLANKHOME;</a>
<a class="sourceLine" id="cb2-46" title="46">            resetGameOver();</a>
<a class="sourceLine" id="cb2-47" title="47">        }</a>
<a class="sourceLine" id="cb2-48" title="48">        <span class="kw">static</span> <span class="dt">void</span> moveTile( <span class="dt">long</span> stride ) { </a>
<a class="sourceLine" id="cb2-49" title="49">            <span class="co">// These use board indexes</span></a>
<a class="sourceLine" id="cb2-50" title="50">            <span class="kw">static</span> <span class="dt">void</span> swapTiles( <span class="dt">long</span> i1, <span class="dt">long</span> i2 ) {</a>
<a class="sourceLine" id="cb2-51" title="51">                swap( board[i1], board[i2] );</a>
<a class="sourceLine" id="cb2-52" title="52">            }</a>
<a class="sourceLine" id="cb2-53" title="53"></a>
<a class="sourceLine" id="cb2-54" title="54">            swapTiles( blankPos, blankPos + stride );</a>
<a class="sourceLine" id="cb2-55" title="55">            blankPos += stride;</a>
<a class="sourceLine" id="cb2-56" title="56">            moves++ ;</a>
<a class="sourceLine" id="cb2-57" title="57">        }</a>
<a class="sourceLine" id="cb2-58" title="58">        <span class="kw">static</span> <span class="dt">void</span> left()  { moveTile( <span class="dv">1</span> ); }</a>
<a class="sourceLine" id="cb2-59" title="59">        <span class="kw">static</span> <span class="dt">void</span> down()  { moveTile( -SIZE ); }</a>
<a class="sourceLine" id="cb2-60" title="60">        <span class="kw">static</span> <span class="dt">void</span> up()    { moveTile( SIZE ); }</a>
<a class="sourceLine" id="cb2-61" title="61">        <span class="kw">static</span> <span class="dt">void</span> right() { moveTile( -<span class="dv">1</span> ); }</a>
<a class="sourceLine" id="cb2-62" title="62"></a>
<a class="sourceLine" id="cb2-63" title="63">        <span class="co">// These are the valid move checks</span></a>
<a class="sourceLine" id="cb2-64" title="64">        <span class="kw">static</span> <span class="dt">bool</span> isValidLeft()  { <span class="kw">return</span> blankCol() != (SIZE - <span class="dv">1</span>); }</a>
<a class="sourceLine" id="cb2-65" title="65">        <span class="kw">static</span> <span class="dt">bool</span> isValidDown()  { <span class="kw">return</span> blankRow() != <span class="dv">0</span>; }</a>
<a class="sourceLine" id="cb2-66" title="66">        <span class="kw">static</span> <span class="dt">bool</span> isValidUp()    { <span class="kw">return</span> blankRow() != (SIZE - <span class="dv">1</span>); }</a>
<a class="sourceLine" id="cb2-67" title="67">        <span class="kw">static</span> <span class="dt">bool</span> isValidRight() { <span class="kw">return</span> blankCol() != <span class="dv">0</span>; } <span class="co">// 0 is invalid, 1 2 3 are all true</span></a>
<a class="sourceLine" id="cb2-68" title="68"></a>
<a class="sourceLine" id="cb2-69" title="69">        <span class="kw">static</span> <span class="dt">void</span> doLeft()  { <span class="kw">if</span> ( isValidLeft() )  left(); }</a>
<a class="sourceLine" id="cb2-70" title="70">        <span class="kw">static</span> <span class="dt">void</span> doDown()  { <span class="kw">if</span> ( isValidDown() )  down(); }</a>
<a class="sourceLine" id="cb2-71" title="71">        <span class="kw">static</span> <span class="dt">void</span> doUp()    { <span class="kw">if</span> ( isValidUp() )    up(); }</a>
<a class="sourceLine" id="cb2-72" title="72">        <span class="kw">static</span> <span class="dt">void</span> doRight() { <span class="kw">if</span> ( isValidRight() ) right(); }</a>
<a class="sourceLine" id="cb2-73" title="73"></a>
<a class="sourceLine" id="cb2-74" title="74">        <span class="kw">static</span> <span class="dt">void</span> shuffleBoard() {</a>
<a class="sourceLine" id="cb2-75" title="75">            <span class="kw">static</span> <span class="dt">void</span> shuffleOneMove() {</a>
<a class="sourceLine" id="cb2-76" title="76">                <span class="kw">final</span> <span class="kw">switch</span>( [ <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ].choice() )</a>
<a class="sourceLine" id="cb2-77" title="77">                {</a>
<a class="sourceLine" id="cb2-78" title="78">                    <span class="kw">case</span> <span class="dv">0</span>: write(<span class="st">&quot; L&quot;</span>); doLeft();  <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-79" title="79">                    <span class="kw">case</span> <span class="dv">1</span>: write(<span class="st">&quot; D&quot;</span>); doDown();  <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-80" title="80">                    <span class="kw">case</span> <span class="dv">2</span>: write(<span class="st">&quot; U&quot;</span>); doUp();    <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-81" title="81">                    <span class="kw">case</span> <span class="dv">3</span>: write(<span class="st">&quot; R&quot;</span>); doRight(); <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-82" title="82">                }</a>
<a class="sourceLine" id="cb2-83" title="83">            }</a>
<a class="sourceLine" id="cb2-84" title="84"></a>
<a class="sourceLine" id="cb2-85" title="85">            <span class="kw">for</span> ( <span class="dt">long</span> i = <span class="dv">0</span>; i &lt; RANDOMLEVEL; i++ )</a>
<a class="sourceLine" id="cb2-86" title="86">                shuffleOneMove();</a>
<a class="sourceLine" id="cb2-87" title="87">        }</a>
<a class="sourceLine" id="cb2-88" title="88"></a>
<a class="sourceLine" id="cb2-89" title="89">        <span class="kw">static</span> <span class="dt">void</span> gameLoop()</a>
<a class="sourceLine" id="cb2-90" title="90">        {</a>
<a class="sourceLine" id="cb2-91" title="91"></a>
<a class="sourceLine" id="cb2-92" title="92">            <span class="kw">static</span> <span class="dt">bool</span> qWinner() { <span class="kw">return</span> board[] == boardInit; }</a>
<a class="sourceLine" id="cb2-93" title="93">            <span class="kw">static</span> <span class="dt">void</span> congratulate() {</a>
<a class="sourceLine" id="cb2-94" title="94">                writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb2-95" title="95">                writefln( <span class="st">&quot; !!! Congratulations on winning the game !!!</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb2-96" title="96">                writefln( <span class="st">&quot; It took %s moves to complete.</span><span class="sc">\r</span><span class="st">&quot;</span>, moves );</a>
<a class="sourceLine" id="cb2-97" title="97">            }</a>
<a class="sourceLine" id="cb2-98" title="98">            <span class="kw">static</span> <span class="dt">void</span> leaveGame() { </a>
<a class="sourceLine" id="cb2-99" title="99">                writeln( <span class="st">&quot; Leaving game.  Thank you for playing.</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb2-100" title="100">                setGameOver();</a>
<a class="sourceLine" id="cb2-101" title="101">            }</a>
<a class="sourceLine" id="cb2-102" title="102"></a>
<a class="sourceLine" id="cb2-103" title="103">            <span class="kw">static</span> <span class="dt">void</span> doHelp() {   writeln();</a>
<a class="sourceLine" id="cb2-104" title="104">                writefln( <span class="st">&quot;   h or left  arrow moves tile left  into blank space.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb2-105" title="105">                writefln( <span class="st">&quot;   l or right arrow moves tile right into blank space.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb2-106" title="106">                writefln( <span class="st">&quot;   j or down  arrow moves tile down  into blank space.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb2-107" title="107">                writefln( <span class="st">&quot;   k or up    arrow moves tile up    into blank space.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb2-108" title="108">                writefln( <span class="st">&quot;   x,q Abandons current game.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb2-109" title="109">                writefln( <span class="st">&quot;   ? This help screen.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb2-110" title="110">            }</a>
<a class="sourceLine" id="cb2-111" title="111"></a>
<a class="sourceLine" id="cb2-112" title="112">            <span class="kw">static</span> <span class="dt">void</span> showBoard( ) {</a>
<a class="sourceLine" id="cb2-113" title="113">                <span class="kw">static</span> <span class="dt">void</span> qNewLine( <span class="dt">long</span> index ) {</a>
<a class="sourceLine" id="cb2-114" title="114">                    <span class="kw">if</span> ( index % SIZE == <span class="dv">0</span> )</a>
<a class="sourceLine" id="cb2-115" title="115">                        writefln!<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>;</a>
<a class="sourceLine" id="cb2-116" title="116">                }</a>
<a class="sourceLine" id="cb2-117" title="117">                <span class="kw">static</span> <span class="dt">void</span> showTile( <span class="dt">long</span> tile ) {</a>
<a class="sourceLine" id="cb2-118" title="118">                    <span class="kw">if</span> ( tile == BLANKHOME )</a>
<a class="sourceLine" id="cb2-119" title="119">                        write( <span class="st">&quot;   &quot;</span> );</a>
<a class="sourceLine" id="cb2-120" title="120">                    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-121" title="121">                        writef( <span class="st">&quot; %2s&quot;</span>, tile );</a>
<a class="sourceLine" id="cb2-122" title="122">                }</a>
<a class="sourceLine" id="cb2-123" title="123"></a>
<a class="sourceLine" id="cb2-124" title="124">                <span class="kw">foreach</span>( i, t; board ) {</a>
<a class="sourceLine" id="cb2-125" title="125">                    qNewLine( i );</a>
<a class="sourceLine" id="cb2-126" title="126">                    showTile( t );</a>
<a class="sourceLine" id="cb2-127" title="127">                }</a>
<a class="sourceLine" id="cb2-128" title="128">            }</a>
<a class="sourceLine" id="cb2-129" title="129"></a>
<a class="sourceLine" id="cb2-130" title="130">            <span class="kw">static</span> <span class="dt">void</span> turn() {</a>
<a class="sourceLine" id="cb2-131" title="131">                @trusted</a>
<a class="sourceLine" id="cb2-132" title="132">                <span class="kw">static</span> <span class="dt">void</span> askForMove() {</a>
<a class="sourceLine" id="cb2-133" title="133">                    write( <span class="st">&quot; hjklxq?&gt; &quot;</span> );</a>
<a class="sourceLine" id="cb2-134" title="134">                    stdout.flush( );</a>
<a class="sourceLine" id="cb2-135" title="135">                }</a>
<a class="sourceLine" id="cb2-136" title="136">                <span class="kw">static</span> <span class="dt">void</span> handleKey( <span class="dt">int</span> asciiKey ) {</a>
<a class="sourceLine" id="cb2-137" title="137">                    <span class="kw">switch</span> ( asciiKey ) {</a>
<a class="sourceLine" id="cb2-138" title="138">                        <span class="kw">case</span> <span class="dv">113</span>: leaveGame(); <span class="kw">break</span>;  <span class="co">// &#39;q&#39;</span></a>
<a class="sourceLine" id="cb2-139" title="139">                        <span class="kw">case</span> <span class="dv">120</span>: leaveGame(); <span class="kw">break</span>;  <span class="co">// &#39;x&#39;</span></a>
<a class="sourceLine" id="cb2-140" title="140">                        <span class="kw">case</span> <span class="dv">104</span>: doLeft();    <span class="kw">break</span>;  <span class="co">// &#39;l&#39;</span></a>
<a class="sourceLine" id="cb2-141" title="141">                        <span class="kw">case</span> <span class="dv">106</span>: doDown();    <span class="kw">break</span>;  <span class="co">// &#39;j&#39;</span></a>
<a class="sourceLine" id="cb2-142" title="142">                        <span class="kw">case</span> <span class="dv">107</span>: doUp();      <span class="kw">break</span>;  <span class="co">// &#39;k&#39;</span></a>
<a class="sourceLine" id="cb2-143" title="143">                        <span class="kw">case</span> <span class="dv">108</span>: doRight();   <span class="kw">break</span>;  <span class="co">// &#39;l&#39;</span></a>
<a class="sourceLine" id="cb2-144" title="144">                        <span class="kw">case</span>  <span class="dv">68</span>: doLeft();    <span class="kw">break</span>;  <span class="co">// arrows</span></a>
<a class="sourceLine" id="cb2-145" title="145">                        <span class="kw">case</span>  <span class="dv">66</span>: doDown();    <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-146" title="146">                        <span class="kw">case</span>  <span class="dv">65</span>: doUp();      <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-147" title="147">                        <span class="kw">case</span>  <span class="dv">67</span>: doRight();   <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-148" title="148">                        <span class="kw">case</span>  <span class="dv">63</span>: doHelp();    <span class="kw">break</span>;  </a>
<a class="sourceLine" id="cb2-149" title="149">                        <span class="kw">default</span>:</a>
<a class="sourceLine" id="cb2-150" title="150">                            writefln( <span class="st">&quot; You pressed %s</span><span class="sc">\r</span><span class="st">&quot;</span>, asciiKey );</a>
<a class="sourceLine" id="cb2-151" title="151">                    }</a>
<a class="sourceLine" id="cb2-152" title="152">                }</a>
<a class="sourceLine" id="cb2-153" title="153"></a>
<a class="sourceLine" id="cb2-154" title="154">                showBoard();</a>
<a class="sourceLine" id="cb2-155" title="155">                writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb2-156" title="156">                askForMove();</a>
<a class="sourceLine" id="cb2-157" title="157">                <span class="kw">auto</span> ch = getch();</a>
<a class="sourceLine" id="cb2-158" title="158">                writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb2-159" title="159">                handleKey( ch );</a>
<a class="sourceLine" id="cb2-160" title="160">            }</a>
<a class="sourceLine" id="cb2-161" title="161"></a>
<a class="sourceLine" id="cb2-162" title="162">            turn();</a>
<a class="sourceLine" id="cb2-163" title="163">            <span class="kw">if</span> (qWinner() ) {</a>
<a class="sourceLine" id="cb2-164" title="164">                showBoard();</a>
<a class="sourceLine" id="cb2-165" title="165">                congratulate();</a>
<a class="sourceLine" id="cb2-166" title="166">                setGameOver();</a>
<a class="sourceLine" id="cb2-167" title="167">            }</a>
<a class="sourceLine" id="cb2-168" title="168">        }</a>
<a class="sourceLine" id="cb2-169" title="169">        <span class="kw">static</span> <span class="dt">void</span> resetMoves() { moves = <span class="dv">0</span>; }</a>
<a class="sourceLine" id="cb2-170" title="170"></a>
<a class="sourceLine" id="cb2-171" title="171">        initGame();</a>
<a class="sourceLine" id="cb2-172" title="172">        shuffleBoard();</a>
<a class="sourceLine" id="cb2-173" title="173">        resetMoves();</a>
<a class="sourceLine" id="cb2-174" title="174">        <span class="kw">while</span>( !qGameOver ) {</a>
<a class="sourceLine" id="cb2-175" title="175">            gameLoop();</a>
<a class="sourceLine" id="cb2-176" title="176">        }</a>
<a class="sourceLine" id="cb2-177" title="177">    }</a>
<a class="sourceLine" id="cb2-178" title="178"></a>
<a class="sourceLine" id="cb2-179" title="179">    <span class="kw">do</span> {</a>
<a class="sourceLine" id="cb2-180" title="180">        playGame();</a>
<a class="sourceLine" id="cb2-181" title="181">        writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb2-182" title="182">        writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb2-183" title="183">        write( <span class="st">&quot; Would you like to play again, y/n?&quot;</span> );</a>
<a class="sourceLine" id="cb2-184" title="184">        stdout.flush( );</a>
<a class="sourceLine" id="cb2-185" title="185">    }</a>
<a class="sourceLine" id="cb2-186" title="186">    <span class="kw">while</span> ( getch() == <span class="dv">121</span> );  <span class="co">// &#39;y&#39;</span></a>
<a class="sourceLine" id="cb2-187" title="187">}</a>
<a class="sourceLine" id="cb2-188" title="188"></a>
<a class="sourceLine" id="cb2-189" title="189"><span class="dt">int</span> main() {</a>
<a class="sourceLine" id="cb2-190" title="190">    <span class="kw">import</span> nwin;</a>
<a class="sourceLine" id="cb2-191" title="191">    initializeNCurses();</a>
<a class="sourceLine" id="cb2-192" title="192">    <span class="kw">scope</span>(<span class="kw">exit</span>) { teardownNCurses(); }</a>
<a class="sourceLine" id="cb2-193" title="193">    anotherGame();</a>
<a class="sourceLine" id="cb2-194" title="194">    <span class="kw">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-195" title="195">}</a></code></pre></div>
</section>
<section id="appendix-d-oop" class="level1">
<h1>Appendix D OOP</h1>
<div class="sourceCode" id="cb3"><pre class="sourceCode d"><code class="sourceCode d"><a class="sourceLine" id="cb3-1" title="1"><span class="co">/+</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">A board is an array of 16 cells to make a 4 x 4 layout</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">The Tiles have the values 0 - 16 where 16 is the &#39;Space&#39;</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">Thus, if the index is the same as the value for all 16 places</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">   the board is in a winning configuration.</span></a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">Use vi keys to shift one tile to the left, right, up, down</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">Use x to leave the game</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">+/</span></a>
<a class="sourceLine" id="cb3-10" title="10"></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="kw">import</span> std.algorithm.mutation : swap;</a>
<a class="sourceLine" id="cb3-12" title="12"><span class="kw">import</span> std.range : iota;</a>
<a class="sourceLine" id="cb3-13" title="13"><span class="kw">import</span> std.stdio : write, writef, writefln, writeln, stdout;</a>
<a class="sourceLine" id="cb3-14" title="14"><span class="kw">import</span> std.array : array;</a>
<a class="sourceLine" id="cb3-15" title="15"><span class="kw">import</span> std.random : choice;</a>
<a class="sourceLine" id="cb3-16" title="16"><span class="kw">import</span> std.format : format;</a>
<a class="sourceLine" id="cb3-17" title="17"></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb3-19" title="19">@safe:</a>
<a class="sourceLine" id="cb3-20" title="20"></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="kw">extern</span>(C) <span class="dt">int</span> getch();</a>
<a class="sourceLine" id="cb3-22" title="22"></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="kw">const</span> SIZE = <span class="dv">4</span>;           <span class="co">// an n x n board</span></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="kw">const</span> RANDOMLEVEL = <span class="dv">20</span>;  <span class="co">// Bigger is harder (more shuffling)</span></a>
<a class="sourceLine" id="cb3-25" title="25"></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="kw">const</span> BOARDSIZE = SIZE * SIZE;</a>
<a class="sourceLine" id="cb3-27" title="27"><span class="kw">const</span> BLANKHOME = BOARDSIZE - <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb3-28" title="28"></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="kw">public</span> <span class="kw">class</span> Board</a>
<a class="sourceLine" id="cb3-30" title="30">{</a>
<a class="sourceLine" id="cb3-31" title="31"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb3-32" title="32">    <span class="kw">const</span> <span class="kw">auto</span> boardInit = iota(<span class="dv">0</span>,BOARDSIZE).array;</a>
<a class="sourceLine" id="cb3-33" title="33">    <span class="dt">int</span>[BOARDSIZE] board;</a>
<a class="sourceLine" id="cb3-34" title="34">    <span class="dt">long</span> moves;</a>
<a class="sourceLine" id="cb3-35" title="35"></a>
<a class="sourceLine" id="cb3-36" title="36">    <span class="dt">long</span> blankPos;</a>
<a class="sourceLine" id="cb3-37" title="37">    <span class="kw">auto</span> blankRow() <span class="kw">const</span> { <span class="kw">return</span> blankPos / SIZE; }</a>
<a class="sourceLine" id="cb3-38" title="38">    <span class="kw">auto</span> blankCol() <span class="kw">const</span> { <span class="kw">return</span> blankPos % SIZE; }</a>
<a class="sourceLine" id="cb3-39" title="39"></a>
<a class="sourceLine" id="cb3-40" title="40">    <span class="dt">void</span> init()</a>
<a class="sourceLine" id="cb3-41" title="41">    {</a>
<a class="sourceLine" id="cb3-42" title="42">        board[]  = boardInit;</a>
<a class="sourceLine" id="cb3-43" title="43">        blankPos = BLANKHOME;</a>
<a class="sourceLine" id="cb3-44" title="44">        moves    = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb3-45" title="45">    }</a>
<a class="sourceLine" id="cb3-46" title="46">    <span class="dt">void</span> moveTile( <span class="dt">long</span> stride ) { </a>
<a class="sourceLine" id="cb3-47" title="47">        <span class="co">// These use board indexes</span></a>
<a class="sourceLine" id="cb3-48" title="48">        <span class="dt">void</span> swapTiles( <span class="dt">long</span> i1, <span class="dt">long</span> i2 ) {</a>
<a class="sourceLine" id="cb3-49" title="49">            swap( board[i1], board[i2] );</a>
<a class="sourceLine" id="cb3-50" title="50">        }</a>
<a class="sourceLine" id="cb3-51" title="51"></a>
<a class="sourceLine" id="cb3-52" title="52">        swapTiles( blankPos, blankPos + stride );</a>
<a class="sourceLine" id="cb3-53" title="53">        blankPos += stride;</a>
<a class="sourceLine" id="cb3-54" title="54">        moves++ ;</a>
<a class="sourceLine" id="cb3-55" title="55">    }</a>
<a class="sourceLine" id="cb3-56" title="56">    <span class="dt">void</span> left()  { moveTile( <span class="dv">1</span> ); }</a>
<a class="sourceLine" id="cb3-57" title="57">    <span class="dt">void</span> down()  { moveTile( -SIZE ); }</a>
<a class="sourceLine" id="cb3-58" title="58">    <span class="dt">void</span> up()    { moveTile( SIZE ); }</a>
<a class="sourceLine" id="cb3-59" title="59">    <span class="dt">void</span> right() { moveTile( -<span class="dv">1</span> ); }</a>
<a class="sourceLine" id="cb3-60" title="60"></a>
<a class="sourceLine" id="cb3-61" title="61">    <span class="co">// These are the valid move checks</span></a>
<a class="sourceLine" id="cb3-62" title="62">    <span class="dt">bool</span> isValidLeft()  { <span class="kw">return</span> blankCol() != (SIZE - <span class="dv">1</span>); }</a>
<a class="sourceLine" id="cb3-63" title="63">    <span class="dt">bool</span> isValidDown()  { <span class="kw">return</span> blankRow() != <span class="dv">0</span>; }</a>
<a class="sourceLine" id="cb3-64" title="64">    <span class="dt">bool</span> isValidUp()    { <span class="kw">return</span> blankRow() != (SIZE - <span class="dv">1</span>); }</a>
<a class="sourceLine" id="cb3-65" title="65">    <span class="dt">bool</span> isValidRight() { <span class="kw">return</span> blankCol() != <span class="dv">0</span>; } <span class="co">// 0 is invalid, 1 2 3 are all true</span></a>
<a class="sourceLine" id="cb3-66" title="66"></a>
<a class="sourceLine" id="cb3-67" title="67">    <span class="dt">void</span> doLeft()  { <span class="kw">if</span> ( isValidLeft() )  left(); }</a>
<a class="sourceLine" id="cb3-68" title="68">    <span class="dt">void</span> doDown()  { <span class="kw">if</span> ( isValidDown() )  down(); }</a>
<a class="sourceLine" id="cb3-69" title="69">    <span class="dt">void</span> doUp()    { <span class="kw">if</span> ( isValidUp() )    up(); }</a>
<a class="sourceLine" id="cb3-70" title="70">    <span class="dt">void</span> doRight() { <span class="kw">if</span> ( isValidRight() ) right(); }</a>
<a class="sourceLine" id="cb3-71" title="71">    <span class="dt">bool</span> qWinner() { <span class="kw">return</span> board[] == boardInit; }</a>
<a class="sourceLine" id="cb3-72" title="72"></a>
<a class="sourceLine" id="cb3-73" title="73">    <span class="dt">void</span> show( ) {</a>
<a class="sourceLine" id="cb3-74" title="74">        <span class="kw">static</span> <span class="dt">void</span> qNewLine( <span class="dt">long</span> index ) {</a>
<a class="sourceLine" id="cb3-75" title="75">            <span class="kw">if</span> ( index % SIZE == <span class="dv">0</span> )</a>
<a class="sourceLine" id="cb3-76" title="76">                writefln!<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>;</a>
<a class="sourceLine" id="cb3-77" title="77">        }</a>
<a class="sourceLine" id="cb3-78" title="78">        <span class="kw">static</span> <span class="dt">void</span> showTile( <span class="dt">long</span> tile ) {</a>
<a class="sourceLine" id="cb3-79" title="79">            <span class="kw">if</span> ( tile == BLANKHOME )</a>
<a class="sourceLine" id="cb3-80" title="80">                write( <span class="st">&quot;   &quot;</span> );</a>
<a class="sourceLine" id="cb3-81" title="81">            <span class="kw">else</span></a>
<a class="sourceLine" id="cb3-82" title="82">                writef( <span class="st">&quot; %2s&quot;</span>, tile );</a>
<a class="sourceLine" id="cb3-83" title="83">        }</a>
<a class="sourceLine" id="cb3-84" title="84"></a>
<a class="sourceLine" id="cb3-85" title="85">        <span class="kw">foreach</span>( i, t; board ) {</a>
<a class="sourceLine" id="cb3-86" title="86">            qNewLine( i );</a>
<a class="sourceLine" id="cb3-87" title="87">            showTile( t );</a>
<a class="sourceLine" id="cb3-88" title="88">        }</a>
<a class="sourceLine" id="cb3-89" title="89">    }</a>
<a class="sourceLine" id="cb3-90" title="90"></a>
<a class="sourceLine" id="cb3-91" title="91"></a>
<a class="sourceLine" id="cb3-92" title="92">}</a>
<a class="sourceLine" id="cb3-93" title="93"></a>
<a class="sourceLine" id="cb3-94" title="94"><span class="kw">public</span> <span class="kw">class</span> Game</a>
<a class="sourceLine" id="cb3-95" title="95">{</a>
<a class="sourceLine" id="cb3-96" title="96"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb3-97" title="97">    <span class="dt">bool</span> qGameOver;</a>
<a class="sourceLine" id="cb3-98" title="98">    <span class="dt">void</span>   setGameOver() { qGameOver = <span class="kw">true</span>; }</a>
<a class="sourceLine" id="cb3-99" title="99">    <span class="dt">void</span> resetGameOver() { qGameOver = <span class="kw">false</span>; }</a>
<a class="sourceLine" id="cb3-100" title="100"></a>
<a class="sourceLine" id="cb3-101" title="101">    Board board;</a>
<a class="sourceLine" id="cb3-102" title="102">    <span class="kw">this</span>( Board board_ )</a>
<a class="sourceLine" id="cb3-103" title="103">    {</a>
<a class="sourceLine" id="cb3-104" title="104">        board = board_;</a>
<a class="sourceLine" id="cb3-105" title="105">        initGame();</a>
<a class="sourceLine" id="cb3-106" title="106">    }</a>
<a class="sourceLine" id="cb3-107" title="107"></a>
<a class="sourceLine" id="cb3-108" title="108">    <span class="dt">void</span> initGame() {</a>
<a class="sourceLine" id="cb3-109" title="109">        board.<span class="dt">init</span>();</a>
<a class="sourceLine" id="cb3-110" title="110">        qGameOver = <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb3-111" title="111">    }</a>
<a class="sourceLine" id="cb3-112" title="112"></a>
<a class="sourceLine" id="cb3-113" title="113">    <span class="dt">void</span> playGame() {</a>
<a class="sourceLine" id="cb3-114" title="114">        <span class="dt">void</span> shuffleBoard() {</a>
<a class="sourceLine" id="cb3-115" title="115">            <span class="dt">void</span> shuffleOneMove() {</a>
<a class="sourceLine" id="cb3-116" title="116">                <span class="kw">final</span> <span class="kw">switch</span>( [ <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ].choice() )</a>
<a class="sourceLine" id="cb3-117" title="117">                {</a>
<a class="sourceLine" id="cb3-118" title="118">                    <span class="kw">case</span> <span class="dv">0</span>: write(<span class="st">&quot; L&quot;</span>); board.doLeft();  <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb3-119" title="119">                    <span class="kw">case</span> <span class="dv">1</span>: write(<span class="st">&quot; D&quot;</span>); board.doDown();  <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb3-120" title="120">                    <span class="kw">case</span> <span class="dv">2</span>: write(<span class="st">&quot; U&quot;</span>); board.doUp();    <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb3-121" title="121">                    <span class="kw">case</span> <span class="dv">3</span>: write(<span class="st">&quot; R&quot;</span>); board.doRight(); <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb3-122" title="122">                }</a>
<a class="sourceLine" id="cb3-123" title="123">            }</a>
<a class="sourceLine" id="cb3-124" title="124"></a>
<a class="sourceLine" id="cb3-125" title="125">            <span class="kw">for</span> ( <span class="dt">long</span> i = <span class="dv">0</span>; i &lt; RANDOMLEVEL; i++ )</a>
<a class="sourceLine" id="cb3-126" title="126">                shuffleOneMove();</a>
<a class="sourceLine" id="cb3-127" title="127">        }</a>
<a class="sourceLine" id="cb3-128" title="128"></a>
<a class="sourceLine" id="cb3-129" title="129">        <span class="dt">void</span> gameLoop()</a>
<a class="sourceLine" id="cb3-130" title="130">        {</a>
<a class="sourceLine" id="cb3-131" title="131">            <span class="dt">void</span> congratulate() <span class="kw">const</span> {</a>
<a class="sourceLine" id="cb3-132" title="132">                writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb3-133" title="133">                writefln( <span class="st">&quot; !!! Congratulations on winning the game !!!</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb3-134" title="134">                writefln( <span class="st">&quot; It took %s moves to complete.</span><span class="sc">\r</span><span class="st">&quot;</span>, board.moves );</a>
<a class="sourceLine" id="cb3-135" title="135">            }</a>
<a class="sourceLine" id="cb3-136" title="136">            <span class="dt">void</span> leaveGame() { </a>
<a class="sourceLine" id="cb3-137" title="137">                writeln( <span class="st">&quot; Leaving game.  Thank you for playing.</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb3-138" title="138">                setGameOver();</a>
<a class="sourceLine" id="cb3-139" title="139">            }</a>
<a class="sourceLine" id="cb3-140" title="140"></a>
<a class="sourceLine" id="cb3-141" title="141">            <span class="kw">static</span> <span class="dt">void</span> doHelp() {   writeln();</a>
<a class="sourceLine" id="cb3-142" title="142">                writefln( <span class="st">&quot;   h or left  arrow moves tile left  into blank space.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb3-143" title="143">                writefln( <span class="st">&quot;   l or right arrow moves tile right into blank space.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb3-144" title="144">                writefln( <span class="st">&quot;   j or down  arrow moves tile down  into blank space.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb3-145" title="145">                writefln( <span class="st">&quot;   k or up    arrow moves tile up    into blank space.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb3-146" title="146">                writefln( <span class="st">&quot;   x,q Abandons current game.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb3-147" title="147">                writefln( <span class="st">&quot;   ? This help screen.</span><span class="sc">\r</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb3-148" title="148">            }</a>
<a class="sourceLine" id="cb3-149" title="149"></a>
<a class="sourceLine" id="cb3-150" title="150">            <span class="dt">void</span> turn() {</a>
<a class="sourceLine" id="cb3-151" title="151">                @trusted</a>
<a class="sourceLine" id="cb3-152" title="152">                <span class="kw">static</span> <span class="dt">void</span> askForMove() {</a>
<a class="sourceLine" id="cb3-153" title="153">                    write( <span class="st">&quot; hjklxq?&gt; &quot;</span> );</a>
<a class="sourceLine" id="cb3-154" title="154">                    stdout.flush( );</a>
<a class="sourceLine" id="cb3-155" title="155">                }</a>
<a class="sourceLine" id="cb3-156" title="156">                <span class="dt">void</span> handleKey( <span class="dt">int</span> asciiKey ) {</a>
<a class="sourceLine" id="cb3-157" title="157">                    <span class="kw">switch</span> ( asciiKey ) {</a>
<a class="sourceLine" id="cb3-158" title="158">                        <span class="kw">case</span> <span class="dv">113</span>: leaveGame(); <span class="kw">break</span>;  <span class="co">// &#39;q&#39;</span></a>
<a class="sourceLine" id="cb3-159" title="159">                        <span class="kw">case</span> <span class="dv">120</span>: leaveGame(); <span class="kw">break</span>;  <span class="co">// &#39;x&#39;</span></a>
<a class="sourceLine" id="cb3-160" title="160">                        <span class="kw">case</span> <span class="dv">104</span>: board.doLeft();    <span class="kw">break</span>;  <span class="co">// &#39;l&#39;</span></a>
<a class="sourceLine" id="cb3-161" title="161">                        <span class="kw">case</span> <span class="dv">106</span>: board.doDown();    <span class="kw">break</span>;  <span class="co">// &#39;j&#39;</span></a>
<a class="sourceLine" id="cb3-162" title="162">                        <span class="kw">case</span> <span class="dv">107</span>: board.doUp();      <span class="kw">break</span>;  <span class="co">// &#39;k&#39;</span></a>
<a class="sourceLine" id="cb3-163" title="163">                        <span class="kw">case</span> <span class="dv">108</span>: board.doRight();   <span class="kw">break</span>;  <span class="co">// &#39;l&#39;</span></a>
<a class="sourceLine" id="cb3-164" title="164">                        <span class="kw">case</span>  <span class="dv">68</span>: board.doLeft();    <span class="kw">break</span>;  <span class="co">// arrows</span></a>
<a class="sourceLine" id="cb3-165" title="165">                        <span class="kw">case</span>  <span class="dv">66</span>: board.doDown();    <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb3-166" title="166">                        <span class="kw">case</span>  <span class="dv">65</span>: board.doUp();      <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb3-167" title="167">                        <span class="kw">case</span>  <span class="dv">67</span>: board.doRight();   <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb3-168" title="168">                        <span class="kw">case</span>  <span class="dv">63</span>: doHelp();    <span class="kw">break</span>;  </a>
<a class="sourceLine" id="cb3-169" title="169">                        <span class="kw">default</span>:</a>
<a class="sourceLine" id="cb3-170" title="170">                            writefln( <span class="st">&quot; You pressed %s</span><span class="sc">\r</span><span class="st">&quot;</span>, asciiKey );</a>
<a class="sourceLine" id="cb3-171" title="171">                    }</a>
<a class="sourceLine" id="cb3-172" title="172">                }</a>
<a class="sourceLine" id="cb3-173" title="173"></a>
<a class="sourceLine" id="cb3-174" title="174">                board.show();</a>
<a class="sourceLine" id="cb3-175" title="175">                writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb3-176" title="176">                askForMove();</a>
<a class="sourceLine" id="cb3-177" title="177">                <span class="kw">auto</span> ch = getch();</a>
<a class="sourceLine" id="cb3-178" title="178">                writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb3-179" title="179">                handleKey( ch );</a>
<a class="sourceLine" id="cb3-180" title="180">            }</a>
<a class="sourceLine" id="cb3-181" title="181"></a>
<a class="sourceLine" id="cb3-182" title="182">            turn();</a>
<a class="sourceLine" id="cb3-183" title="183">            <span class="kw">if</span> (board.qWinner() ) {</a>
<a class="sourceLine" id="cb3-184" title="184">                board.show();</a>
<a class="sourceLine" id="cb3-185" title="185">                congratulate();</a>
<a class="sourceLine" id="cb3-186" title="186">                setGameOver();</a>
<a class="sourceLine" id="cb3-187" title="187">            }</a>
<a class="sourceLine" id="cb3-188" title="188">        }</a>
<a class="sourceLine" id="cb3-189" title="189"></a>
<a class="sourceLine" id="cb3-190" title="190">        initGame();</a>
<a class="sourceLine" id="cb3-191" title="191">        shuffleBoard();</a>
<a class="sourceLine" id="cb3-192" title="192">        <span class="kw">while</span>( !qGameOver ) {</a>
<a class="sourceLine" id="cb3-193" title="193">            gameLoop();</a>
<a class="sourceLine" id="cb3-194" title="194">        }</a>
<a class="sourceLine" id="cb3-195" title="195">    }</a>
<a class="sourceLine" id="cb3-196" title="196"></a>
<a class="sourceLine" id="cb3-197" title="197">    @trusted</a>
<a class="sourceLine" id="cb3-198" title="198">    <span class="kw">public</span> <span class="dt">void</span> anotherGame( ) {</a>
<a class="sourceLine" id="cb3-199" title="199"></a>
<a class="sourceLine" id="cb3-200" title="200">        <span class="kw">do</span> {</a>
<a class="sourceLine" id="cb3-201" title="201">            playGame();</a>
<a class="sourceLine" id="cb3-202" title="202">            writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb3-203" title="203">            writeln(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb3-204" title="204">            write( <span class="st">&quot; Would you like to play again, y/n?&quot;</span> );</a>
<a class="sourceLine" id="cb3-205" title="205">            stdout.flush( );</a>
<a class="sourceLine" id="cb3-206" title="206">        }</a>
<a class="sourceLine" id="cb3-207" title="207">        <span class="kw">while</span> ( getch() == <span class="dv">121</span> );  <span class="co">// &#39;y&#39;</span></a>
<a class="sourceLine" id="cb3-208" title="208">    }</a>
<a class="sourceLine" id="cb3-209" title="209">}</a>
<a class="sourceLine" id="cb3-210" title="210"></a>
<a class="sourceLine" id="cb3-211" title="211"><span class="dt">int</span> main() {</a>
<a class="sourceLine" id="cb3-212" title="212">    <span class="kw">import</span> nwin;</a>
<a class="sourceLine" id="cb3-213" title="213">    initializeNCurses();</a>
<a class="sourceLine" id="cb3-214" title="214">    <span class="kw">scope</span>(<span class="kw">exit</span>) { teardownNCurses(); }</a>
<a class="sourceLine" id="cb3-215" title="215">    <span class="kw">auto</span> board = <span class="kw">new</span> Board();</a>
<a class="sourceLine" id="cb3-216" title="216">    <span class="kw">auto</span> game = <span class="kw">new</span> Game( board );</a>
<a class="sourceLine" id="cb3-217" title="217">    game.anotherGame();</a>
<a class="sourceLine" id="cb3-218" title="218">    <span class="kw">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb3-219" title="219">}</a></code></pre></div>
</section>
</article>
</body>
</html>
